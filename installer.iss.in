; PSDToolKit Installer Script - Generated by CMake
; Supports both standard and portable installation modes

#define MyAppName "PSDToolKit"
#define MyAppVersion "@PTK_INSTALLER_VERSION@"
#define MyAppPublisher "oov"
#define MyAppURL "https://github.com/oov/aviutl2_psdtoolkit2"

[Setup]
AppId={{DD101687-983B-4A37-A374-52BAEFC437E2}
AppName={#MyAppName}
AppVersion={#MyAppVersion}
AppPublisher={#MyAppPublisher}
AppPublisherURL={#MyAppURL}
AppSupportURL={#MyAppURL}
AppUpdatesURL={#MyAppURL}
DefaultDirName=C:\ProgramData\aviutl2\Plugin
UninstallFilesDir={app}\{#MyAppName}
UninstallDisplayName={#MyAppName} {#MyAppVersion}
DisableDirPage=yes
DisableProgramGroupPage=yes
DisableReadyPage=yes
InfoBeforeFile=@PTK_README_FILE@
OutputDir=@PTK_INSTALLER_OUTPUT_DIR@
OutputBaseFilename=psdtoolkit_@PTK_INSTALLER_VERSION@_setup
Compression=lzma
SolidCompression=yes
WizardStyle=dynamic
ArchitecturesInstallIn64BitMode=x64compatible
PrivilegesRequired=lowest
CreateUninstallRegKey=not IsPortableMode
Uninstallable=not IsPortableMode

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"
Name: "japanese"; MessagesFile: "compiler:Languages\Japanese.isl"
Name: "chinesesimplified"; MessagesFile: "@PTK_CHINESE_SIMPLIFIED_ISL@"

[CustomMessages]
english.InstallModeTitle=Installation Mode
english.InstallModeDescription=Select how you want to install {#MyAppName}.
english.StandardInstall=Standard Installation
english.StandardInstallDesc=Install to the default location with uninstaller registration.
english.PortableInstall=Portable Installation
english.PortableInstallDesc=Install for portable AviUtl2 without uninstaller registration.
english.SelectAviUtl2=Please select aviutl2.exe:
english.AviUtl2Filter=AviUtl2 Executable(aviutl2.exe)|aviutl2.exe
english.AviUtl2NotFound=aviutl2.exe was not found. Please select aviutl2.exe.
english.PortableInstallLocation=Install location: %1
japanese.InstallModeTitle=インストールモード
japanese.InstallModeDescription={#MyAppName} のインストール方法を選択してください。
japanese.StandardInstall=通常インストール
japanese.StandardInstallDesc=既定の場所にインストールし、アンインストーラーを登録します。
japanese.PortableInstall=ポータブルインストール
japanese.PortableInstallDesc=ポータブル版 AviUtl2 向けにインストールします。アンインストーラーは登録しません。
japanese.SelectAviUtl2=aviutl2.exe を選択してください:
japanese.AviUtl2Filter=AviUtl2 実行ファイル(aviutl2.exe)|aviutl2.exe
japanese.AviUtl2NotFound=aviutl2.exe が見つかりません。aviutl2.exe を選択してください。
japanese.PortableInstallLocation=インストール先: %1
chinesesimplified.InstallModeTitle=安装模式
chinesesimplified.InstallModeDescription=请选择 {#MyAppName} 的安装方式。
chinesesimplified.StandardInstall=标准安装
chinesesimplified.StandardInstallDesc=安装到默认位置，并注册卸载程序。
chinesesimplified.PortableInstall=便携安装
chinesesimplified.PortableInstallDesc=为便携版 AviUtl2 安装，不注册卸载程序。
chinesesimplified.SelectAviUtl2=请选择 aviutl2.exe:
chinesesimplified.AviUtl2Filter=AviUtl2 可执行文件(aviutl2.exe)|aviutl2.exe
chinesesimplified.AviUtl2NotFound=未找到 aviutl2.exe。请选择 aviutl2.exe。
chinesesimplified.PortableInstallLocation=安装位置: %1

[Files]
Source: "@PTK_BUILD_OUTPUT_DIR@\Plugin\PSDToolKit\*"; DestDir: "{app}\PSDToolKit"; Flags: ignoreversion recursesubdirs createallsubdirs
Source: "@PTK_BUILD_OUTPUT_DIR@\Script\PSDToolKit\*"; DestDir: "{app}\..\Script\PSDToolKit"; Flags: ignoreversion recursesubdirs createallsubdirs
Source: "@PTK_BUILD_OUTPUT_DIR@\Alias\*"; DestDir: "{app}\..\Alias"; Flags: ignoreversion
Source: "@PTK_BUILD_OUTPUT_DIR@\Language\*.PSDToolKit.aul2"; DestDir: "{app}\..\Language"; Flags: ignoreversion

[InstallDelete]
; Remove old installation files (migration happens in CurStepChanged before this)
Type: files; Name: "{app}\PSDToolKit.aux2"
Type: files; Name: "{app}\PSDToolKit.txt"

[Code]
var
  InstallModePage: TWizardPage;
  StandardRadio, PortableRadio: TNewRadioButton;
  AviUtl2PathEdit: TNewEdit;
  BrowseButton: TNewButton;
  InstallLocationLabel: TLabel;
  PortableMode: Boolean;
  PortableInstallDir: String;

function IsPortableMode: Boolean;
begin
  Result := PortableMode;
end;

function GetInstallDir(Param: String): String;
begin
  if PortableMode and (PortableInstallDir <> '') then
    Result := PortableInstallDir
  else
    Result := ExpandConstant('{app}');
end;

procedure UpdateInstallLocation;
var
  AviUtl2Dir, DataDir: String;
begin
  if not PortableRadio.Checked then
  begin
    InstallLocationLabel.Caption := '';
    PortableInstallDir := '';
    Exit;
  end;

  if AviUtl2PathEdit.Text = '' then
  begin
    InstallLocationLabel.Caption := '';
    PortableInstallDir := '';
    Exit;
  end;

  AviUtl2Dir := ExtractFileDir(AviUtl2PathEdit.Text);
  DataDir := AddBackslash(AviUtl2Dir) + 'data';

  if DirExists(DataDir) then
    PortableInstallDir := AddBackslash(DataDir) + 'Plugin'
  else
    PortableInstallDir := ExpandConstant('C:\ProgramData\aviutl2\Plugin');

  InstallLocationLabel.Caption := FmtMessage(CustomMessage('PortableInstallLocation'), [PortableInstallDir]);
end;

procedure BrowseButtonClick(Sender: TObject);
var
  FileName: String;
begin
  FileName := AviUtl2PathEdit.Text;
  if GetOpenFileName(CustomMessage('SelectAviUtl2'), FileName, '', CustomMessage('AviUtl2Filter'), 'exe') then
  begin
    AviUtl2PathEdit.Text := FileName;
    UpdateInstallLocation;
  end;
end;

procedure RadioClick(Sender: TObject);
begin
  AviUtl2PathEdit.Enabled := PortableRadio.Checked;
  BrowseButton.Enabled := PortableRadio.Checked;
  UpdateInstallLocation;
end;

procedure InitializeWizard;
var
  DescLabel: TLabel;
  TopPos: Integer;
begin
  PortableMode := False;
  PortableInstallDir := '';

  InstallModePage := CreateCustomPage(wpInfoBefore,
    CustomMessage('InstallModeTitle'),
    CustomMessage('InstallModeDescription'));

  TopPos := 16;

  StandardRadio := TNewRadioButton.Create(InstallModePage);
  StandardRadio.Parent := InstallModePage.Surface;
  StandardRadio.Caption := CustomMessage('StandardInstall');
  StandardRadio.Top := TopPos;
  StandardRadio.Left := 0;
  StandardRadio.Width := InstallModePage.SurfaceWidth;
  StandardRadio.Checked := True;
  StandardRadio.Font.Style := [];
  StandardRadio.OnClick := @RadioClick;

  TopPos := TopPos + StandardRadio.Height + 4;

  DescLabel := TLabel.Create(InstallModePage);
  DescLabel.Parent := InstallModePage.Surface;
  DescLabel.Caption := CustomMessage('StandardInstallDesc');
  DescLabel.Top := TopPos;
  DescLabel.Left := 20;
  DescLabel.Width := InstallModePage.SurfaceWidth - 20;
  DescLabel.WordWrap := True;

  TopPos := TopPos + DescLabel.Height + 24;

  PortableRadio := TNewRadioButton.Create(InstallModePage);
  PortableRadio.Parent := InstallModePage.Surface;
  PortableRadio.Caption := CustomMessage('PortableInstall');
  PortableRadio.Top := TopPos;
  PortableRadio.Left := 0;
  PortableRadio.Width := InstallModePage.SurfaceWidth;
  PortableRadio.Font.Style := [];
  PortableRadio.OnClick := @RadioClick;

  TopPos := TopPos + PortableRadio.Height + 4;

  DescLabel := TLabel.Create(InstallModePage);
  DescLabel.Parent := InstallModePage.Surface;
  DescLabel.Caption := CustomMessage('PortableInstallDesc');
  DescLabel.Top := TopPos;
  DescLabel.Left := 20;
  DescLabel.Width := InstallModePage.SurfaceWidth - 20;
  DescLabel.WordWrap := True;

  TopPos := TopPos + DescLabel.Height + 16;

  DescLabel := TLabel.Create(InstallModePage);
  DescLabel.Parent := InstallModePage.Surface;
  DescLabel.Caption := CustomMessage('SelectAviUtl2');
  DescLabel.Top := TopPos;
  DescLabel.Left := 20;
  DescLabel.Width := InstallModePage.SurfaceWidth - 20;

  TopPos := TopPos + DescLabel.Height + 4;

  AviUtl2PathEdit := TNewEdit.Create(InstallModePage);
  AviUtl2PathEdit.Parent := InstallModePage.Surface;
  AviUtl2PathEdit.Top := TopPos;
  AviUtl2PathEdit.Left := 20;
  AviUtl2PathEdit.Width := InstallModePage.SurfaceWidth - 120;
  AviUtl2PathEdit.Enabled := False;

  BrowseButton := TNewButton.Create(InstallModePage);
  BrowseButton.Parent := InstallModePage.Surface;
  BrowseButton.Caption := '...';
  BrowseButton.Top := TopPos - 2;
  BrowseButton.Left := AviUtl2PathEdit.Left + AviUtl2PathEdit.Width + 8;
  BrowseButton.Width := 80;
  BrowseButton.Enabled := False;
  BrowseButton.OnClick := @BrowseButtonClick;

  TopPos := TopPos + AviUtl2PathEdit.Height + 8;

  InstallLocationLabel := TLabel.Create(InstallModePage);
  InstallLocationLabel.Parent := InstallModePage.Surface;
  InstallLocationLabel.Top := TopPos;
  InstallLocationLabel.Left := 20;
  InstallLocationLabel.Width := InstallModePage.SurfaceWidth - 20;
  InstallLocationLabel.Font.Style := [];
  InstallLocationLabel.Caption := '';
end;

function NextButtonClick(CurPageID: Integer): Boolean;
begin
  Result := True;
  if CurPageID = InstallModePage.ID then
  begin
    PortableMode := PortableRadio.Checked;
    if PortableMode then
    begin
      if (AviUtl2PathEdit.Text = '') or (not FileExists(AviUtl2PathEdit.Text)) then
      begin
        MsgBox(CustomMessage('AviUtl2NotFound'), mbError, MB_OK);
        Result := False;
        Exit;
      end;
      WizardForm.DirEdit.Text := PortableInstallDir;
    end;
  end;
end;

procedure MigrateOldInstallation;
var
  OldScriptDir: String;
  OldScriptFile1, OldScriptFile2, OldScriptFile3: String;
  FindRec: TFindRec;
begin
  // Remove old script files from oov directory
  OldScriptDir := ExpandConstant('{app}\..\Script\oov');
  OldScriptFile1 := OldScriptDir + '\@PSDToolKit.anm2';
  OldScriptFile2 := OldScriptDir + '\@PSDToolKit.obj2';
  OldScriptFile3 := OldScriptDir + '\PSDToolKit.lua';

  if FileExists(OldScriptFile1) then
    DeleteFile(OldScriptFile1);
  if FileExists(OldScriptFile2) then
    DeleteFile(OldScriptFile2);
  if FileExists(OldScriptFile3) then
    DeleteFile(OldScriptFile3);

  // Remove oov directory if empty
  if DirExists(OldScriptDir) then
  begin
    if not FindFirst(OldScriptDir + '\*', FindRec) then
    begin
      // Directory is empty, remove it
      RemoveDir(OldScriptDir);
    end
    else
    begin
      // Check if only . and .. entries exist
      if (FindRec.Name = '.') or (FindRec.Name = '..') then
      begin
        if not FindNext(FindRec) then
        begin
          FindClose(FindRec);
          RemoveDir(OldScriptDir);
        end
        else if ((FindRec.Name = '.') or (FindRec.Name = '..')) and not FindNext(FindRec) then
        begin
          FindClose(FindRec);
          RemoveDir(OldScriptDir);
        end
        else
        begin
          FindClose(FindRec);
        end;
      end
      else
      begin
        FindClose(FindRec);
      end;
    end;
  end;
end;

procedure CurStepChanged(CurStep: TSetupStep);
begin
  if CurStep = ssInstall then
  begin
    // Perform migration before InstallDelete runs
    MigrateOldInstallation;
  end;
end;
